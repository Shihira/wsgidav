<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Comic Reader</title>
  <meta name="description" content="">
  <meta name="viewport" content="width=device-width, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">

  <script src="https://cdn.staticfile.org/jquery/3.3.1/jquery.min.js"></script>
  <script src="https://cdn.bootcss.com/jquery.lazy/1.7.10/jquery.lazy.min.js"></script>
  <script src="/Pages/assets/utils.js"></script>

<style>
.comic-displayer {
  display: inline-block;
  max-width: 100%;
}

.comic-displayer-container {
  text-align: center;
  margin-top: 5px;
  margin-bottom: 5px;
}

.comic-displayer-number {
  position: absolute;
  bottom: 5px;
  right: 0px;
  padding: 5px;
  background: rgba(0, 0, 0, 0.5);
  color: #aaa;
  border-radius: 5px 0px 0px 0px;
  cursor: pointer;
}

.comic-chapter {
  color: #aaa;
  display: block;
  text-decoration: none;
  padding: 5px;
  padding-left: 10px;
  margin: 10px;
  text-align: /*center*/left;
  border: #444 solid 1px;
}

.comic-chapter:hover {
  background: #444;
}
</style>
</head>
<body style="overflow: auto; background: #222;">
  <div id="book">
  </div>

  <p style="text-align: center; padding-top: 20px; margin-top: 20px; border-top: solid #666 1px; color: #999;">
    The copyright of this App is reserved by Shihira Fung, and the copyright of content is reserved by the author.
  </p>

  <script>

    function initReader(chapter, data)
    {
      if (chapter === "" || data[chapter] === undefined)
        chapter = Object.keys(data)[0];

      var pages = data[chapter];

      for (var i = 0; i < pages; ++i) {
        var page = $(
          '<div class="comic-displayer-container">' +
          '  <div style="position: relative; display: inline-block;">' +
          '    <img class="comic-displayer"/>' +
          '    <span class="comic-displayer-number"/>' +
          '  </div>' +
          '</div>');

        var displayer = page.find(".comic-displayer");
        displayer.attr("src", "/Pages/assets/comic-loading.png");
        displayer.attr("data-page", i + 1);
        displayer.attr("data-src", get_param("file") + "?" + $.param({
          q: "img",
          chapter: chapter,
          page: i,
          max_size: 2048,
        }));

        var page_number = page.find(".comic-displayer-number");
        page_number.text(i + 1);
        page_number.click(function() {
          var cur_num = parseInt($(this).text());
          var p = prompt("Go to page (Current: " + cur_num + "/" + pages + ")");
          p = parseInt(p);

          window.scrollTo(0, $("[data-page=" + p + "]").offset().top);
        });

        $("#book").append(page);

        displayer.css("min-height", "400px");
        displayer.lazy({
          enableThrottle: true,
          throttle: 250,
          afterLoad: function(elem) {
            $(elem).css("min-height", "");
          }
        });
      }
    }

    function initChapter(data)
    {
      var chapters = Object.keys(data).sort();

      for (var i in chapters) {
        var chapter = chapters[i];
        href = location.pathname + "?" + $.param({
          "file": get_param("file"),
          "chapter": chapter,
        });
        if (chapters.length == 1) {
          location.href = href;
          return;
        }

        var link = $("<a></a>")
        link.attr("href", href);
        link.attr("target", "_blank");
        link.addClass("comic-chapter");
        link.text(chapter ? chapter : "Untitled");

        console.log(link);

        $("#book").append(link);
      }
    }

    $(document).ready(function() {
      var filename = get_param("file");
      if (!filename)
        return;

      $.get(filename, {q: "info"}, function(data) {
        var chapter = get_param("chapter");
        if (chapter === null)
          initChapter(data);
        else
          initReader(chapter, data);
      })
    });
  </script>
</body>
</html>
